version: "3.9"

networks:
    playground:
        driver: overlay

services:
    swarm-hello-world:
        image: lumaghg/swarm-hello-world:20231017.11
        ports:
            - 3000:4000
        environment:
            - port=4000
        deploy:
            labels:
                - "traefik.enable=true"
                - "traefik.http.routers.whoami.rule=Host(`whoami.localhost`)"
                - "traefik.http.routers.whoami.entrypoints=web"
                - "traefik.http.services.whoami.loadbalancer.server.port=4000"
            replicas: 2
            update_config:
                order: start-first
                parallelism: 0

                failure_action: rollback
                monitor: 5s
        networks:
            - playground

    traefik:
        image: "traefik:v2.9"
        command:
            - "--log.level=DEBUG"
            - "--providers.docker=true"
            - "--providers.docker.exposedbydefault=false"
            - "--providers.docker.swarmMode=true"
            - "--entrypoints.web.address=:80"
            - "--accesslog=true"
            - "--tracing.jaeger=true"
            - "--tracing.jaeger.samplingServerURL=http://jaeger:5778/sampling"
            - "--tracing.jaeger.localAgentHostPort=jaeger:6831"
            - "--tracing.jaeger.propagation=jaeger"
            - "--api.insecure=true"
            - "--providers.docker.network=pg_playground"
        ports:
            - 80:80

        volumes:
            - "//var/run/docker.sock:/var/run/docker.sock:ro"

        deploy:
            placement:
                constraints:
                    - node.role == manager
        networks:
            - playground

    jaeger:
        image: jaegertracing/all-in-one:1.46
        environment:
            - COLLECTOR_ZIPKIN_HTTP_PORT=:9411
            - COLLECTOR_OTLP_ENABLED=true
            - SPAN_STORAGE_TYPE=elasticsearch
        command:
            [
                "--es.server-urls=http://elasticsearch:9200",
                "--es.num-shards=1",
                "--es.num-replicas=0",
                "--log-level=error",
                "--span-storage.type=elasticsearch",
            ]
        depends_on:
            - elasticsearch
        ports:
            - 6831:6831/udp
            - 6832:6832/udp

            - 5778:5778
            - 16685:16685
            - 16686:16686
            - 14268:14268
            - 14269:14269
            - 14250:14250
            - 9411:9411
            - 4317:4317
            - 4318:4318
        networks:
            - playground

    elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:6.3.1
        ports:
            - "9200:9200"
            - "9300:9300"
        environment:
            - cluster.name=jaeger-cluster
            - discovery.type=single-node
            - http.host=0.0.0.0
            - transport.host=127.0.0.1
            - ES_JAVA_OPTS=-Xms512m -Xmx512m
            - xpack.security.enabled=false
        volumes:
            - ./esdata:/usr/share/elasticsearch/data
        networks:
            - playground
